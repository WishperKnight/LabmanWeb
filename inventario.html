<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario | Lab Track</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <div id="status-container" class="mt-3"></div>

            <header class="d-flex justify-content-between align-items-center mb-4 mt-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">Inventario de Materiales</h2>
                    <p class="text-muted small m-0">Reactivos y Fungibles (excluyendo Vidriería).</p>
                </div>
                <div class="d-flex gap-2">
                    <label class="btn btn-outline-primary rounded-pill px-4 shadow-sm fw-bold mb-0">
                        <i class="fas fa-file-upload me-2"></i>Importar Materiales
                        <input type="file" id="input-csv" accept=".csv" hidden>
                    </label>
                </div>
            </header>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group bg-white rounded-pill shadow-sm px-3 border">
                        <span class="input-group-text bg-transparent border-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="buscador" class="form-control border-0 bg-transparent" placeholder="Buscar reactivo, lote o marca...">
                    </div>
                </div>
            </div>

            <div class="card-premium border-0 shadow-sm bg-white rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table align-middle m-0">
                        <thead class="bg-light text-muted small fw-bold text-uppercase">
                            <tr>
                                <th class="ps-4">Material / Marca</th>
                                <th>Tipo</th>
                                <th>Stock</th>
                                <th>Lote</th>
                                <th>Caducidad</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-inventario">
                            <tr><td colspan="6" class="text-center p-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Cargando inventario...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light">
                    <div class="text-muted small">Mostrando <span id="page-info" class="fw-bold">0-0</span> de <span id="total-info">0</span></div>
                    <nav>
                        <ul class="pagination pagination-sm m-0 gap-2">
                            <li class="page-item"><button class="page-link rounded-circle border-0 shadow-sm" id="prev-page"><i class="fas fa-chevron-left"></i></button></li>
                            <li class="page-item"><button class="page-link rounded-circle border-0 shadow-sm" id="next-page"><i class="fas fa-chevron-right"></i></button></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { importarCSV, mostrarFeedback } from './importador-csv.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('inventario');

        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let dataFull = [];
        let dataFiltered = [];
        let page = 1;
        const perPage = 10;

        // --- CARGA Y ESCUCHA ---
        onSnapshot(collection(db, "inventario"), (snap) => {
            dataFull = [];
            snap.forEach(d => dataFull.push({ id: d.id, ...d.data() }));
            filtrar();
        });

        // --- FILTRADO ---
        document.getElementById('buscador').oninput = (e) => filtrar(e.target.value);

        function filtrar(term = "") {
            const q = term.toLowerCase();
            dataFiltered = dataFull.filter(m => 
                m.nombre.toLowerCase().includes(q) || 
                (m.lote && m.lote.toLowerCase().includes(q)) ||
                (m.marca && m.marca.toLowerCase().includes(q))
            );
            page = 1;
            render();
        }

        // --- RENDERIZADO ---
        function render() {
            const cont = document.getElementById('lista-inventario');
            const start = (page - 1) * perPage;
            const end = start + perPage;
            const items = dataFiltered.slice(start, end);

            cont.innerHTML = items.length ? "" : '<tr><td colspan="6" class="text-center p-5">No se encontraron materiales.</td></tr>';

            items.forEach(m => {
                const stockAlerta = m.cantidad < 5 ? 'text-danger fw-bold' : '';
                cont.innerHTML += `
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">${m.nombre}</div>
                            <div class="text-muted small">${m.marca || 'N/A'}</div>
                        </td>
                        <td><span class="badge bg-blue-subtle text-primary border-0">${m.tipo}</span></td>
                        <td class="${stockAlerta}">${m.cantidad} uds</td>
                        <td><small class="bg-light px-2 py-1 rounded border">${m.lote || 'N/A'}</small></td>
                        <td>
                            <span class="small text-muted"><i class="far fa-calendar me-1"></i>${m.caducidad || 'S/F'}</span>
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-light text-danger rounded-circle" onclick="eliminarMaterial('${m.id}', '${m.nombre}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            document.getElementById('page-info').innerText = `${start + 1}-${Math.min(end, dataFiltered.length)}`;
            document.getElementById('total-info').innerText = dataFiltered.length;
            document.getElementById('prev-page').disabled = page === 1;
            document.getElementById('next-page').disabled = end >= dataFiltered.length;
        }

        // --- NAVEGACIÓN ---
        document.getElementById('prev-page').onclick = () => { if(page > 1) { page--; render(); }};
        document.getElementById('next-page').onclick = () => { if((page * perPage) < dataFiltered.length) { page++; render(); }};

        // --- ELIMINAR ---
        window.eliminarMaterial = async (id, nombre) => {
            if (confirm(`¿Eliminar ${nombre} del inventario?`)) await deleteDoc(doc(db, "inventario", id));
        };

        // --- IMPORTAR ---
        document.getElementById('input-csv').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const n = await importarCSV(file, db, "inventario");
                    mostrarFeedback(`¡${n} materiales cargados!`, 'success', 'status-container');
                } catch (err) {
                    mostrarFeedback(err, 'danger', 'status-container');
                }
            }
        };
    </script>

    <style>
        .bg-blue-subtle { background-color: #eef2ff; color: #4338ca; }
        .page-link { cursor: pointer; transition: 0.2s; }
        .page-link:hover { background: #3b82f6 !important; color: white !important; }
        .page-link:disabled { opacity: 0.3; cursor: not-allowed; }
    </style>
</body>
</html>