<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios | Lab Track</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-dark m-0">Administración de Usuarios</h2>
                        <p class="text-muted small m-0">Control de permisos y acceso al sistema.</p>
                    </div>
                    <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="abrirModalNuevoUsuario()">
                        <i class="fas fa-user-plus me-2"></i>Añadir Usuario
                    </button>
                </div>

                <div class="row g-3 bg-white p-3 rounded-4 shadow-sm border">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="busqueda-usuario" class="form-control bg-light border-0" placeholder="Buscar por nombre o email...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="filtro-rol" class="form-select bg-light border-0">
                            <option value="todos">Todos los roles</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="tecnico">Técnico</option>
                            <option value="usuario">Usuario</option>
                        </select>
                    </div>
                </div>
            </header>

            <div class="card-premium border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="text-muted small fw-bold text-uppercase">
                            <tr>
                                <th class="ps-4">Usuario</th>
                                <th>Email</th>
                                <th>Rol Actual</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-usuarios"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalNuevoUsuario" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-success">Registrar Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-nuevo-usuario">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Nombre Completo</label>
                            <input type="text" id="nuevo-nombre" class="form-control bg-light border-0 rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Correo Electrónico</label>
                            <input type="email" id="nuevo-email" class="form-control bg-light border-0 rounded-3" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Asignar Rol</label>
                            <select id="nuevo-rol" class="form-select bg-light border-0 rounded-3" required>
                                <option value="usuario">Usuario (Consulta)</option>
                                <option value="tecnico">Técnico (Inventario)</option>
                                <option value="Supervisor">Supervisor (Full)</option>
                            </select>
                        </div>
                        <p class="text-muted" style="font-size: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i> El usuario podrá acceder una vez que su correo esté registrado en el sistema.
                        </p>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-success w-100 rounded-pill py-2 fw-bold shadow-sm">Crear Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRol" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-primary">Modificar Permisos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="user-id-rol">
                    <p class="small text-muted mb-4">Nuevo nivel de acceso para <b id="user-nombre-rol"></b>:</p>
                    <select id="select-nuevo-rol" class="form-select form-select-lg border-0 bg-light rounded-4">
                        <option value="Supervisor">Supervisor</option>
                        <option value="tecnico">Técnico</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button onclick="guardarNuevoRol()" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">Actualizar Rol</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('usuarios');

        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let todosLosUsuarios = [];

        // --- ABRIR MODAL NUEVO ---
        window.abrirModalNuevoUsuario = () => {
            document.getElementById('form-nuevo-usuario').reset();
            new bootstrap.Modal(document.getElementById('modalNuevoUsuario')).show();
        };

        // --- GUARDAR NUEVO USUARIO ---
        document.getElementById('form-nuevo-usuario').onsubmit = async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('nuevo-nombre').value;
            const email = document.getElementById('nuevo-email').value;
            const rol = document.getElementById('nuevo-rol').value;

            try {
                await addDoc(collection(db, "usuarios"), {
                    nombre: nombre,
                    email: email,
                    rol: rol,
                    fechaCreacion: new Date().toISOString()
                });
                bootstrap.Modal.getInstance(document.getElementById('modalNuevoUsuario')).hide();
            } catch (error) {
                alert("Error al crear usuario: " + error.message);
            }
        };

        // --- FILTRADO Y TABLA ---
        const aplicarFiltros = () => {
            const texto = document.getElementById('busqueda-usuario').value.toLowerCase();
            const rolSeleccionado = document.getElementById('filtro-rol').value;
            const filtrados = todosLosUsuarios.filter(u => {
                const coincideTexto = (u.nombre || "").toLowerCase().includes(texto) || (u.email || "").toLowerCase().includes(texto);
                const coincideRol = rolSeleccionado === "todos" || u.rol === rolSeleccionado;
                return coincideTexto && coincideRol;
            });
            renderizarTabla(filtrados);
        };

        const renderizarTabla = (usuarios) => {
            const cont = document.getElementById('lista-usuarios');
            cont.innerHTML = "";
            usuarios.forEach(u => {
                const rolColor = u.rol === 'Supervisor' ? 'bg-danger' : (u.rol === 'tecnico' ? 'bg-primary' : 'bg-secondary');
                cont.innerHTML += `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-muted"></i>
                                </div>
                                <div class="fw-bold text-dark">${u.nombre || 'Sin nombre'}</div>
                            </div>
                        </td>
                        <td><span class="text-muted small">${u.email}</span></td>
                        <td><span class="badge ${rolColor}-subtle ${rolColor.replace('bg-', 'text-')} rounded-pill px-3">${(u.rol || 'usuario').toUpperCase()}</span></td>
                        <td class="text-end pe-4">
                            <button onclick="prepararCambioRol('${u.id}', '${u.nombre}', '${u.rol}')" class="btn btn-sm btn-light rounded-circle shadow-sm text-primary me-2"><i class="fas fa-user-shield"></i></button>
                            <button onclick="eliminarUsuario('${u.id}', '${u.nombre}')" class="btn btn-sm btn-light rounded-circle shadow-sm text-danger"><i class="fas fa-user-minus"></i></button>
                        </td>
                    </tr>`;
            });
        };

        onSnapshot(collection(db, "usuarios"), (snap) => {
            todosLosUsuarios = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            aplicarFiltros();
        });

        document.getElementById('busqueda-usuario').oninput = aplicarFiltros;
        document.getElementById('filtro-rol').onchange = aplicarFiltros;

        window.prepararCambioRol = (id, nombre, rolActual) => {
            document.getElementById('user-id-rol').value = id;
            document.getElementById('user-nombre-rol').innerText = nombre;
            document.getElementById('select-nuevo-rol').value = rolActual;
            new bootstrap.Modal(document.getElementById('modalRol')).show();
        };

        window.guardarNuevoRol = async () => {
            try {
                await updateDoc(doc(db, "usuarios", document.getElementById('user-id-rol').value), {
                    rol: document.getElementById('select-nuevo-rol').value
                });
                bootstrap.Modal.getInstance(document.getElementById('modalRol')).hide();
            } catch (error) { alert("Error al actualizar."); }
        };

        window.eliminarUsuario = async (id, nombre) => {
            if (confirm(`¿Eliminar a ${nombre}?`)) {
                await deleteDoc(doc(db, "usuarios", id));
            }
        };
    </script>
</body>
</html>