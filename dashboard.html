<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Lab Track</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h2 class="fw-bold text-dark m-0">Hola de nuevo, Administrador</h2>
                    <p class="text-muted small m-0">Estado de los laboratorios en tiempo real.</p>
                </div>
                <div class="bg-white px-3 py-2 rounded-3 shadow-sm fw-bold border">
                    <i class="far fa-calendar-alt me-2 text-primary"></i> 12 de enero, 2026
                </div>
            </header>

            <div class="row g-4 mb-5">
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-blue">
                        <div class="icon-box"><i class="fas fa-hospital"></i></div>
                        <div><h2 id="count-labs" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">SEDES</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-green">
                        <div class="icon-box"><i class="fas fa-microscope"></i></div>
                        <div><h2 id="count-ejecuciones" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">PROCESOS</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-red">
                        <div class="icon-box"><i class="fas fa-bolt"></i></div>
                        <div><h2 id="count-incidencias" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">INCIDENCIAS</small></div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-card-premium card-dark">
                        <div class="icon-box"><i class="fas fa-user-md"></i></div>
                        <div><h2 id="count-users" class="fw-bold mb-0">0</h2><small class="text-muted fw-bold">PERSONAL</small></div>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-lg-7">
                    <div class="card-premium h-100">
                        <h6 class="fw-bold mb-4"><i class="fas fa-sync-alt fa-spin me-2 text-primary"></i>Ejecuciones en curso</h6>
                        <div id="contenedor-ejecuciones"></div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card-premium h-100">
                        <h6 class="fw-bold mb-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Alertas Críticas</h6>
                        <div id="contenedor-incidencias"></div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-12">
                    <div class="card-premium">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h6 class="fw-bold m-0"><i class="fas fa-list me-2 text-primary"></i>Detalle de Laboratorios</h6>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle">
                                <thead class="text-muted small">
                                    <tr>
                                        <th>LABORATORIO</th>
                                        <th>UBICACIÓN</th>
                                        <th>CAPACIDAD</th>
                                        <th class="text-end">ESTADO</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-laboratorios-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        cargarSidebar('dashboard');

        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- EJECUCIONES ---
        onSnapshot(collection(db, "ejecuciones"), (snap) => {
            document.getElementById('count-ejecuciones').innerText = snap.size;
            const cont = document.getElementById('contenedor-ejecuciones');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const e = doc.data();
                const progreso = e.estado === 'Completado' ? 100 : (e.estado === 'En curso' ? 65 : 15);
                cont.innerHTML += `
                    <div class="p-3 mb-3 bg-light rounded-4 border">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div><span class="fw-bold d-block text-dark">${e.protocolo}</span><small class="text-muted">${e.tecnico}</small></div>
                            <span class="badge ${progreso === 100 ? 'bg-success' : 'bg-primary'} rounded-pill">${e.estado}</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar ${progreso === 100 ? 'bg-success' : 'bg-primary'} progress-bar-striped progress-bar-animated" style="width: ${progreso}%"></div>
                        </div>
                    </div>`;
            });
        });

        // --- INCIDENCIAS CON GESTIÓN ---
        onSnapshot(collection(db, "incidencias"), (snap) => {
            const cont = document.getElementById('contenedor-incidencias');
            cont.innerHTML = "";
            let activos = 0;

            snap.forEach(docSnap => {
                const i = docSnap.data();
                if (i.estado === 'cerrado') return; // Filtro para no mostrar cerradas
                
                activos++;
                cont.innerHTML += `
                    <div class="p-3 mb-2 border-start border-danger border-4 bg-light rounded-end d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold small text-danger">${i.laboratorio}</span>
                                <small class="text-muted ms-3">${i.FechaDeRegistro ? i.FechaDeRegistro.substring(0,10) : 'Hoy'}</small>
                            </div>
                            <p class="small mb-0 text-dark fw-bold">${i.Momento || 'Alerta'}</p>
                            <p class="small text-muted mb-0 lh-sm">${i.Descripcion}</p>
                        </div>
                        <button onclick="gestionarIncidencia('${docSnap.id}')" class="btn btn-sm btn-white border shadow-sm rounded-circle text-success ms-2">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>`;
            });
            document.getElementById('count-incidencias').innerText = activos;
            if (activos === 0) cont.innerHTML = '<div class="text-center py-4 text-muted small">Sin alertas pendientes.</div>';
        });

        // Función Global para Cerrar Incidencia
        window.gestionarIncidencia = async (id) => {
            if (confirm("¿Marcar esta incidencia como resuelta?")) {
                try {
                    await updateDoc(doc(db, "incidencias", id), { estado: "cerrado" });
                } catch (e) { alert("Error al actualizar"); }
            }
        };

        // --- LABORATORIOS ---
        onSnapshot(collection(db, "laboratorios"), (snap) => {
            document.getElementById('count-labs').innerText = snap.size;
            const cont = document.getElementById('tabla-laboratorios-body');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const l = doc.data();
                cont.innerHTML += `
                    <tr>
                        <td><div class="fw-bold text-dark">${l.nombre || 'Sede'}</div></td>
                        <td><span class="text-muted small">${l.ubicacion || 'N/A'}</span></td>
                        <td><span class="badge bg-light text-dark border">${l.capacidad || '0'} equipos</span></td>
                        <td class="text-end"><span class="badge bg-success-subtle text-success">Activo</span></td>
                    </tr>`;
            });
        });

        onSnapshot(collection(db, "usuarios"), s => document.getElementById('count-users').innerText = s.size);
    </script>
</body>
</html>