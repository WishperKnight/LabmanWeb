<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Lab Track</title>
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/707/707675.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="mobile-header d-none justify-content-between align-items-center bg-dark text-white p-3 shadow-sm">
        <span class="fw-bold">LAB TRACK</span>
        <button class="btn text-white" id="btnToggleSidebar"><i class="fas fa-bars fa-lg"></i></button>
    </div>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <header class="mb-5">
                <h2 class="fw-bold text-dark">Panel de Control</h2>
                <p class="text-muted">Estado actual de las operaciones en tiempo real.</p>
            </header>

            <div class="row g-4 mb-5">
                <div class="col-6 col-lg-3">
                    <div class="card-custom stat-card bg-primary">
                        <i class="fas fa-hospital stat-icon"></i>
                        <small class="fw-bold opacity-75">SEDES</small>
                        <h2 id="count-labs" class="fw-bold mb-0">0</h2>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card-custom stat-card bg-success">
                        <i class="fas fa-microscope stat-icon"></i>
                        <small class="fw-bold opacity-75">PROCESOS</small>
                        <h2 id="count-ejecuciones" class="fw-bold mb-0">0</h2>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card-custom stat-card bg-danger">
                        <i class="fas fa-exclamation-triangle stat-icon"></i>
                        <small class="fw-bold opacity-75">ALERTAS</small>
                        <h2 id="count-incidencias" class="fw-bold mb-0">0</h2>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="card-custom stat-card bg-dark">
                        <i class="fas fa-user-md stat-icon"></i>
                        <small class="fw-bold opacity-75">PERSONAL</small>
                        <h2 id="count-users" class="fw-bold mb-0">0</h2>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card-custom h-100">
                        <h6 class="fw-bold mb-4 text-uppercase small text-muted">Ejecuciones en curso</h6>
                        <div id="contenedor-ejecuciones" class="scroll-section px-2"></div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card-custom h-100">
                        <h6 class="fw-bold mb-4 text-uppercase small text-muted">Registro de Incidencias</h6>
                        <div id="contenedor-incidencias" class="scroll-section px-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Inicializar Sidebar
        cargarSidebar('dashboard');

        // Toggle Sidebar MÃ³vil
        const btnToggle = document.getElementById('btnToggleSidebar');
        if(btnToggle) {
            btnToggle.onclick = () => document.getElementById('sidebar-container').classList.toggle('active');
        }

        // Firebase Config
        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            storageBucket: "labmanager-b85b1.firebasestorage.app", 
            messagingSenderId: "651630503448", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CARGA DE DATOS (Campos exactos de tu imagen) ---

        // Ejecuciones
        onSnapshot(collection(db, "ejecuciones"), (snap) => {
            document.getElementById('count-ejecuciones').innerText = snap.size;
            const cont = document.getElementById('contenedor-ejecuciones');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const e = doc.data();
                cont.innerHTML += `
                    <div class="p-3 mb-3 border rounded-4 bg-light d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0 text-dark">${e.protocolo}</h6>
                            <small class="text-primary fw-bold"><i class="fas fa-user-circle me-1"></i>${e.tecnico}</small>
                        </div>
                        <span class="badge bg-success-subtle text-success border border-success px-3 rounded-pill">${e.estado}</span>
                    </div>`;
            });
        });

        // Incidencias
        onSnapshot(collection(db, "incidencias"), (snap) => {
            document.getElementById('count-incidencias').innerText = snap.size;
            const cont = document.getElementById('contenedor-incidencias');
            cont.innerHTML = "";
            snap.forEach(doc => {
                const i = doc.data();
                cont.innerHTML += `
                    <div class="p-3 mb-3 border-start border-danger border-4 bg-white rounded-end shadow-sm">
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-danger text-white mb-2">${i.laboratorio}</span>
                            <small class="text-muted">${i.FechaDeRegistro.substring(0,10)}</small>
                        </div>
                        <p class="fw-bold mb-1 small text-dark">${i.Momento}</p>
                        <p class="small text-muted mb-0">${i.Descripcion}</p>
                    </div>`;
            });
        });

        // Labs y Usuarios
        onSnapshot(collection(db, "laboratorios"), (s) => document.getElementById('count-labs').innerText = s.size);
        onSnapshot(collection(db, "usuarios"), (s) => document.getElementById('count-users').innerText = s.size);

    </script>
</body>
</html>