<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipos Técnicos | Lab Track</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid">
            <div id="status-container" class="mt-3"></div>

            <header class="d-flex justify-content-between align-items-center mb-5 mt-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">Gestión de Equipos</h2>
                    <p class="text-muted small m-0">Inventario técnico extraído de base de datos oficial.</p>
                </div>
                <div class="d-flex gap-2">
                    <label class="btn btn-outline-primary rounded-pill px-4 shadow-sm fw-bold mb-0">
                        <i class="fas fa-file-csv me-2"></i>Importar CSV
                        <input type="file" id="input-csv" accept=".csv" hidden>
                    </label>
                    <button class="btn btn-primary rounded-pill px-4 shadow-sm fw-bold" onclick="abrirModalNuevo()">
                        <i class="fas fa-plus me-2"></i>Nuevo Equipo
                    </button>
                </div>
            </header>

            <div class="card-premium border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table align-middle custom-table">
                        <thead class="text-muted small fw-bold text-uppercase">
                            <tr>
                                <th class="ps-4">Código / Equipo</th>
                                <th>Serial / Marca</th>
                                <th>Categoría</th>
                                <th>Sede/Lab</th>
                                <th>Estado</th>
                                <th>Notas</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="lista-equipos">
                            <tr><td colspan="7" class="text-center p-5 text-muted">Conectando con el inventario...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 px-4 pt-4">
                    <h5 class="fw-bold m-0 text-primary" id="modal-titulo">Ficha Técnica de Equipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-equipo">
                    <input type="hidden" id="eq-id">
                    <div class="modal-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Código Interno (PDF)</label>
                                <input type="text" id="eq-codigo" class="form-control rounded-3 bg-light border-0" placeholder="Ej: LBB006">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label small fw-bold">Nombre del Equipo / Modelo</label>
                                <input type="text" id="eq-nombre" class="form-control rounded-3 bg-light border-0" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Número de Serie (S/N)</label>
                                <input type="text" id="eq-serial" class="form-control rounded-3 bg-light border-0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Fabricante / Marca</label>
                                <input type="text" id="eq-fabricante" class="form-control rounded-3 bg-light border-0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Categoría</label>
                                <select id="eq-tipo" class="form-select rounded-3 bg-light border-0">
                                    <option value="Medición">Medición</option>
                                    <option value="Volumetría">Volumetría</option>
                                    <option value="Óptica">Óptica</option>
                                    <option value="Térmico">Térmico</option>
                                    <option value="Otros">Otros</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Laboratorio</label>
                                <select id="eq-lab" class="form-select rounded-3 bg-light border-0" required></select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Estado</label>
                                <select id="eq-estado" class="form-select rounded-3 bg-light border-0">
                                    <option value="Operativo">Operativo</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                    <option value="Baja">Fuera de Servicio</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">Observaciones del PDF</label>
                                <textarea id="eq-obs" class="form-control rounded-3 bg-light border-0" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4 pt-0">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">Guardar Equipo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { importarCSV, mostrarFeedback } from './importador-csv.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Inicialización
        cargarSidebar('equipos');
        
        const firebaseConfig = { 
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", 
            authDomain: "labmanager-b85b1.firebaseapp.com", 
            projectId: "labmanager-b85b1", 
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const modalEq = new bootstrap.Modal(document.getElementById('modalEquipo'));

        // --- MANEJO DE CSV ---
        document.getElementById('input-csv').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const total = await importarCSV(file, db, "equipos");
                mostrarFeedback(`¡Éxito! Se han importado ${total} equipos del inventario.`, 'success', 'status-container');
            } catch (err) {
                mostrarFeedback(err, 'danger', 'status-container');
            }
            e.target.value = "";
        });

        // --- RENDERIZADO EN TIEMPO REAL ---
        onSnapshot(collection(db, "equipos"), (snap) => {
            const cont = document.getElementById('lista-equipos');
            cont.innerHTML = "";
            
            snap.forEach(d => {
                const e = d.data();
                const badgeColor = e.estado === 'Operativo' ? 'bg-success' : 'bg-warning text-dark';
                
                cont.innerHTML += `
                    <tr>
                        <td class="ps-4">
                            <span class="badge bg-dark mb-1" style="font-size: 0.6rem;">${e.codigoInterno || 'S/C'}</span>
                            <div class="fw-bold text-primary">${e.nombre}</div>
                        </td>
                        <td>
                            <div class="small fw-bold">${e.serial || 'S/N'}</div>
                            <div class="text-muted small text-uppercase">${e.fabricante || '-'}</div>
                        </td>
                        <td><span class="badge bg-light text-dark border">${e.tipo}</span></td>
                        <td><div class="small text-muted"><i class="fas fa-microscope me-1"></i>${e.laboratorio}</div></td>
                        <td><span class="badge ${badgeColor} rounded-pill px-3" style="font-size: 0.7rem;">${e.estado}</span></td>
                        <td><div class="small text-muted text-truncate" style="max-width: 120px;">${e.observaciones || '-'}</div></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-light text-primary rounded-circle shadow-sm" onclick="editarEquipo('${d.id}')"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-sm btn-light text-danger rounded-circle shadow-sm" onclick="eliminarEquipo('${d.id}', '${e.nombre}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        });

        // --- FUNCIONES CRUD ---
        window.abrirModalNuevo = () => {
            document.getElementById('eq-id').value = "";
            document.getElementById('form-equipo').reset();
            document.getElementById('modal-titulo').innerText = "Registrar Nuevo Equipo";
            modalEq.show();
        };

        window.editarEquipo = async (id) => {
            const snap = await getDoc(doc(db, "equipos", id));
            const e = snap.data();
            document.getElementById('eq-id').value = id;
            document.getElementById('eq-codigo').value = e.codigoInterno || "";
            document.getElementById('eq-nombre').value = e.nombre;
            document.getElementById('eq-serial').value = e.serial || "";
            document.getElementById('eq-fabricante').value = e.fabricante || "";
            document.getElementById('eq-tipo').value = e.tipo;
            document.getElementById('eq-lab').value = e.laboratorio;
            document.getElementById('eq-estado').value = e.estado;
            document.getElementById('eq-obs').value = e.observaciones || "";
            document.getElementById('modal-titulo').innerText = "Editar Equipo";
            modalEq.show();
        };

        window.eliminarEquipo = async (id, nombre) => {
            if (confirm(`¿Eliminar ${nombre}?`)) await deleteDoc(doc(db, "equipos", id));
        };

        // Guardar
        document.getElementById('form-equipo').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('eq-id').value;
            const data = {
                codigoInterno: document.getElementById('eq-codigo').value,
                nombre: document.getElementById('eq-nombre').value,
                serial: document.getElementById('eq-serial').value,
                fabricante: document.getElementById('eq-fabricante').value,
                tipo: document.getElementById('eq-tipo').value,
                laboratorio: document.getElementById('eq-lab').value,
                estado: document.getElementById('eq-estado').value,
                observaciones: document.getElementById('eq-obs').value,
                fechaMod: new Date().toISOString()
            };
            id ? await updateDoc(doc(db, "equipos", id), data) : await addDoc(collection(db, "equipos"), data);
            modalEq.hide();
        };

        // Cargar labs en select
        onSnapshot(collection(db, "laboratorios"), (snap) => {
            const s = document.getElementById('eq-lab');
            s.innerHTML = '<option value="" disabled selected>Seleccionar...</option>';
            snap.forEach(d => s.innerHTML += `<option value="${d.data().nombre}">${d.data().nombre}</option>`);
        });

    </script>
</body>
</html>