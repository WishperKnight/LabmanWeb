<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Detalles de Registro - Lab Track</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid py-4">
            <div class="card-custom mx-auto shadow-lg border-0" style="max-width: 850px;">
                <div class="p-4 bg-primary text-white rounded-top-4 d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-uppercase opacity-75 fw-bold" id="txt-coleccion">Cargando...</small>
                        <h2 class="fw-bold mb-0" id="txt-nombre-principal">---</h2>
                    </div>
                    <button class="btn btn-light btn-sm rounded-pill px-3 shadow-sm" onclick="window.history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Regresar
                    </button>
                </div>

                <div class="p-4 p-md-5 bg-white rounded-bottom-4">
                    <div id="loading-spinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Consultando base de datos...</p>
                    </div>

                    <form id="form-edit" class="d-none">
                        <div class="row g-4">
                            <div class="col-12">
                                <label class="form-label text-muted small fw-bold uppercase">Nombre del Registro</label>
                                <input type="text" id="inp-nombre" class="form-control form-control-lg border-0 bg-light rounded-3">
                            </div>

                            <div id="contenedor-dinamico" class="row g-4 m-0 p-0"></div>

                            <div class="col-12 mt-4">
                                <label class="form-label text-muted small fw-bold">Notas e Incidencias</label>
                                <textarea id="inp-notas" class="form-control border-0 bg-light rounded-3" rows="4" placeholder="Escriba observaciones técnicas aquí..."></textarea>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-5 pt-4 border-top">
                            <button type="button" id="btn-eliminar" class="btn btn-link text-danger text-decoration-none p-0">
                                <i class="fas fa-trash-alt me-2"></i>Eliminar permanentemente
                            </button>
                            <button type="button" id="btn-guardar" class="btn btn-primary px-5 py-2 fw-bold rounded-3 shadow">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA", authDomain: "labmanager-b85b1.firebaseapp.com", projectId: "labmanager-b85b1", storageBucket: "labmanager-b85b1.firebasestorage.app", messagingSenderId: "651630503448", appId: "1:651630503448:web:9a327cbf30b84fd763c56d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const col = params.get('col');

        if(!id || !col) window.location.href = "dashboard.html";
        cargarSidebar(col);

        const docRef = doc(db, col, id);

        async function init() {
            try {
                const snap = await getDoc(docRef);
                if(!snap.exists()) {
                    alert("El registro no existe.");
                    window.history.back();
                    return;
                }
                const data = snap.data();
                
                // Llenar campos base
                document.getElementById('txt-coleccion').innerText = col;
                document.getElementById('txt-nombre-principal').innerText = data.nombre || data.protocolo || "Sin nombre";
                document.getElementById('inp-nombre').value = data.nombre || data.protocolo || "";
                document.getElementById('inp-notas').value = data.anotaciones || "";

                // Generar campos según el diagrama E-R
                let html = '';
                if(col === 'inventario') {
                    html = `
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Cantidad Actual</label>
                            <input type="number" id="ext-1" class="form-control" value="${data.cantidadActual || 0}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Capacidad Total</label>
                            <input type="number" id="ext-2" class="form-control" value="${data.capacidadTotal || 0}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Tipo</label>
                            <input type="text" id="ext-3" class="form-control" value="${data.tipo || ''}" readonly>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Ubicación (Almacén)</label>
                            <input type="text" id="ext-4" class="form-control" value="${data.ubicacion || ''}">
                        </div>`;
                } else if(col === 'equipos') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Fabricante</label>
                            <input type="text" id="ext-1" class="form-control" value="${data.fabricante || ''}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Nº de Serie</label>
                            <input type="text" id="ext-2" class="form-control" value="${data.numSerie || ''}">
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Estado del Equipo</label>
                            <select id="ext-3" class="form-select">
                                <option value="Funcional" ${data.estado === 'Funcional' ? 'selected' : ''}>Funcional</option>
                                <option value="En Reparación" ${data.estado === 'En Reparación' ? 'selected' : ''}>En Reparación</option>
                                <option value="Desechado" ${data.estado === 'Desechado' ? 'selected' : ''}>Desechado</option>
                            </select>
                        </div>`;
                } else if(col === 'ejecuciones') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Técnico Interviene</label>
                            <input type="text" id="ext-1" class="form-control" value="${data.tecnico || ''}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">Estado de Ejecución</label>
                            <select id="ext-2" class="form-select">
                                <option value="En Curso" ${data.estado === 'En Curso' ? 'selected' : ''}>En Curso</option>
                                <option value="Completado" ${data.estado === 'Completado' ? 'selected' : ''}>Completado</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted">Descripción del Protocolo</label>
                            <textarea id="ext-3" class="form-control" rows="3">${data.descripcion || ''}</textarea>
                        </div>`;
                }

                document.getElementById('contenedor-dinamico').innerHTML = html;
                document.getElementById('loading-spinner').classList.add('d-none');
                document.getElementById('form-edit').classList.remove('d-none');

            } catch (err) { console.error(err); }
        }

        init();

        // GUARDAR CAMBIOS
        document.getElementById('btn-guardar').onclick = async () => {
            const btn = document.getElementById('btn-guardar');
            btn.disabled = true;
            btn.innerHTML = "Guardando...";

            let updateObj = {
                anotaciones: document.getElementById('inp-notas').value
            };

            // Mapeo inverso según la colección
            if(col === 'ejecuciones') updateObj.protocolo = document.getElementById('inp-nombre').value;
            else updateObj.nombre = document.getElementById('inp-nombre').value;

            if(col === 'inventario') {
                updateObj.cantidadActual = Number(document.getElementById('ext-1').value);
                updateObj.capacidadTotal = Number(document.getElementById('ext-2').value);
                updateObj.ubicacion = document.getElementById('ext-4').value;
            } else if(col === 'equipos') {
                updateObj.fabricante = document.getElementById('ext-1').value;
                updateObj.numSerie = document.getElementById('ext-2').value;
                updateObj.estado = document.getElementById('ext-3').value;
            } else if(col === 'ejecuciones') {
                updateObj.tecnico = document.getElementById('ext-1').value;
                updateObj.estado = document.getElementById('ext-2').value;
                updateObj.descripcion = document.getElementById('ext-3').value;
            }

            await updateDoc(docRef, updateObj);
            window.location.href = col + ".html";
        };

        // ELIMINAR
        document.getElementById('btn-eliminar').onclick = async () => {
            if(confirm("¿Eliminar este registro permanentemente?")) {
                await deleteDoc(docRef);
                window.location.href = col + ".html";
            }
        };
    </script>
</body>
</html>