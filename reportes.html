<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Lab Track</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%233b82f6%22 d=%22M352 320c-23.03 0-44.42 8.35-61.1 22.06l-67.9-20.94c4.6-11.41 7-23.59 7-36.12 0-53.02-42.98-96-96-96s-96 42.98-96 96 42.98 96 96 96c8.48 0 16.63-1.11 24.39-3.18l67.35 20.77C226.04 443.34 224 447.45 224 452c0 33.14 26.86 60 60 60h168c33.14 0 60-26.86 60-60v-72c0-33.14-26.86-60-60-60H352zM134 320c-18.78 0-34-15.22-34-34s15.22-34 34-34 34 15.22 34 34-15.22 34-34 34z%22/></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="sidebar-container"></div>

    <div class="main">
        <div class="container-fluid py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-0">Gestión de Incidencias</h2>
                    <p class="text-muted small">Registro vinculado a laboratorios y personal activo.</p>
                </div>
                <button class="btn btn-danger shadow-sm px-4 fw-bold" data-bs-toggle="modal"
                    data-bs-target="#modalIncidencia">
                    <i class="fas fa-plus-circle me-2"></i>Nueva Incidencia
                </button>
            </div>

            <div class="card-custom p-0 overflow-hidden shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase small fw-bold">
                            <tr>
                                <th class="ps-4 py-3">Laboratorio</th>
                                <th>Momento / Descripción</th>
                                <th>Reportado por</th>
                                <th class="text-end pe-4">Fecha Registro</th>
                            </tr>
                        </thead>
                        <tbody id="incidencias-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalIncidencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg p-3">
                <div class="modal-header border-0">
                    <h5 class="fw-bold text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Registrar Incidencia
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Laboratorio</label>
                        <select id="incLaboratorio" class="form-select">
                            <option value="" selected disabled>Cargando laboratorios...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Usuario que Reporta</label>
                        <select id="incUsuario" class="form-select">
                            <option value="" selected disabled>Cargando personal...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Momento</label>
                        <input type="text" id="incMomento" class="form-control"
                            placeholder="Ej: Durante la fase de pesaje">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Descripción</label>
                        <textarea id="incDescripcion" class="form-control" rows="3"
                            placeholder="Detalle lo sucedido..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger px-4 fw-bold" id="btnSaveIncidencia">Guardar
                        Reporte</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { cargarSidebar } from './sidebar.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_aXLKh1HXcXGD1_s7mA7VuCPsSm1IBPA",
            authDomain: "labmanager-b85b1.firebaseapp.com",
            projectId: "labmanager-b85b1",
            storageBucket: "labmanager-b85b1.firebasestorage.app",
            messagingSenderId: "651630503448",
            appId: "1:651630503448:web:9a327cbf30b84fd763c56d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        cargarSidebar('reportes');

        // CARGA DINÁMICA DE LABORATORIOS Y USUARIOS
        const cargarSelectores = async () => {
            const selectLab = document.getElementById('incLaboratorio');
            const selectUser = document.getElementById('incUsuario');

            // Cargar Laboratorios desde la colección 'laboratorios'
            const labsSnap = await getDocs(collection(db, "laboratorios"));
            selectLab.innerHTML = '<option value="" selected disabled>Seleccione laboratorio...</option>';
            labsSnap.forEach(doc => {
                const l = doc.data();
                const opt = document.createElement('option');
                opt.value = l.nombre;
                opt.textContent = l.nombre;
                selectLab.appendChild(opt);
            });

            // Cargar Usuarios con su Rol
            const usersSnap = await getDocs(collection(db, "usuarios"));
            selectUser.innerHTML = '<option value="" selected disabled>Seleccione informante...</option>';
            usersSnap.forEach(doc => {
                const u = doc.data();
                const opt = document.createElement('option');
                opt.value = u.nombre; // Guardamos solo el nombre en la BD para la incidencia
                opt.textContent = `${u.nombre} (${u.rol || 'Sin rol'})`; // Mostramos nombre + rol en el selector
                selectUser.appendChild(opt);
            });
        };

        cargarSelectores();

        // RENDERIZAR TABLA DE INCIDENCIAS
        onSnapshot(collection(db, "incidencias"), (snapshot) => {
            const body = document.getElementById('incidencias-body');
            body.innerHTML = '';
            snapshot.forEach(doc => {
                const i = doc.data();
                body.innerHTML += `
                    <tr>
                        <td class="ps-4 fw-bold text-dark">${i.laboratorio}</td>
                        <td>
                            <div class="small text-danger fw-bold text-uppercase" style="font-size:0.65rem;">${i.Momento}</div>
                            <div>${i.Descripcion}</div>
                        </td>
                        <td class="text-primary fw-medium">${i.usuarioNombre}</td>
                        <td class="text-end pe-4 text-muted small">${i.FechaDeRegistro}</td>
                    </tr>`;
            });
        });

        // GUARDAR INCIDENCIA
        document.getElementById('btnSaveIncidencia').onclick = async () => {
            const lab = document.getElementById('incLaboratorio').value;
            const user = document.getElementById('incUsuario').value;
            const mom = document.getElementById('incMomento').value;
            const des = document.getElementById('incDescripcion').value;

            if (!lab || !user || !des) return alert("Por favor complete todos los campos obligatorios.");

            try {
                const fecha = new Date().toLocaleString('es-ES', {
                    day: 'numeric', month: 'long', year: 'numeric',
                    hour: 'numeric', minute: 'numeric'
                }) + " UTC+1";

                await addDoc(collection(db, "incidencias"), {
                    laboratorio: lab,
                    Momento: mom,
                    Descripcion: des,
                    FechaDeRegistro: fecha,
                    usuarioNombre: user
                });

                bootstrap.Modal.getInstance(document.getElementById('modalIncidencia')).hide();
                document.getElementById('modalIncidencia').querySelectorAll('input, textarea, select').forEach(el => el.value = '');
            } catch (e) { console.error(e); }
        };
    </script>
</body>

</html>